<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzI5NjJmZiIgZD0iTTE5LDNINWMtMS4xLDAtMiwwLjktMiwydjE0YzAsMS4xLDAuOSwyLDIsMmgxNGMxLjEsMCwyLTAuOSwyLTJWNUMyMSwzLjksMjAuMSwzLDE5LDN6IE0xNywxM2gtNHY0aC0ydi00SDd2LTJoNFY3aDJ2NGg0VjEzeiIvPjwvc3ZnPg=="
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Notepad</title>
    <!-- Add JetBrains Mono font -->
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        /* Dark theme (default) */
        --bg-color: #292929;
        --text-color: #d4d4d4;
        --line-number-color: #858585;
        --highlight-color: #264f78;
        --toolbar-bg: #333333;
        --tab-bg: #2d2d2d;
        --tab-active-bg: #1e1e1e;
        --border-color: #555;
      }

      /* Light theme */
      [data-theme="light"] {
        --bg-color: #fdfdf7;
        --text-color: #000000;
        --line-number-color: #999999;
        --highlight-color: #e3f2fd;
        --toolbar-bg: #f5f5f5;
        --tab-bg: #ebebeb;
        --tab-active-bg: #ffffff;
        --border-color: #ccc;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "JetBrains Mono", monospace;
        background-color: var(--bg-color);
        color: var(--text-color);
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* Modified layout styles */
      .main-container {
        display: flex;
        flex: 1;
        overflow: hidden;
      }

      .tabs-container {
        width: 200px;
        background-color: var(--toolbar-bg);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }

      .tab {
        padding: 8px;
        background-color: var(--tab-bg);
        border-bottom: 1px solid var(--border-color);
        color: var(--text-color);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        text-align: left;
      }

      .tab.active {
        background-color: var(--tab-active-bg);
        border-left: 3px solid #007acc;
      }

      .tab-name {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .content-container {
        display: flex;
        flex-direction: column;
        flex: 1;
        overflow: hidden;
        min-height: 0; /* Added for Firefox */
      }
      .toolbar {
        background-color: var(--toolbar-bg);
        padding: 8px;
        display: flex;
        gap: 12px;
        border-bottom: 1px solid var(--border-color);
        justify-content: center;
        align-items: center;
      }

      .toolbar button {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px;
        background-color: var(--tab-bg);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        cursor: pointer;
        border-radius: 6px;
        width: 40px;
        height: 40px;
        transition: all 0.2s ease;
      }

      .toolbar button:hover {
        background-color: var(--tab-active-bg);
        transform: translateY(-1px);
      }

      .toolbar button svg {
        width: 20px;
        height: 20px;
        fill: currentColor;
      }

      .tabs-container {
        background-color: var(--toolbar-bg);
        display: flex;
        overflow-x: auto;
        border-bottom: 1px solid var(--border-color);
      }

      .tab {
        padding: 8px 16px;
        background-color: var(--tab-bg);
        border: none;
        border-right: 1px solid var(--border-color);
        color: var(--text-color);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 120px;
        max-width: 200px;
      }

      .tab-close {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: none;
        background-color: transparent;
        color: var(--text-color);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        margin-left: auto;
      }

      .tab-close:hover {
        background-color: var(--border-color);
      }

      .editor-container {
        flex: 1; /* Changed from flex-grow: 1 */
        overflow: hidden;
        position: relative;
        min-height: 0; /* Added for Firefox */
      }

      .editor-wrapper {
        display: flex;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: none;
      }

      .editor-wrapper.active {
        display: flex;
      }

      .line-numbers {
        padding: 8px 8px 8px 0;
        background-color: var(--bg-color);
        color: var(--line-number-color);
        text-align: right;
        user-select: none;
        border-right: 1px solid var(--border-color);
        overflow-y: hidden;
        min-width: 40px;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
      }

      .editor {
        flex-grow: 1;
        padding: 8px;
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: "JetBrains Mono", monospace;
        font-size: 16px;
        line-height: 1.5;
        resize: none;
        border: none;
        outline: none;
        white-space: pre;
        overflow-wrap: normal;
        overflow-x: auto;
      }

      .editor:focus {
        outline: none;
      }

      .status-bar {
        flex-shrink: 0; /* Added to prevent shrinking */
        background-color: var(--toolbar-bg);
        padding: 4px 8px;
        font-size: 12px;
        display: flex;
        justify-content: space-between;
        border-top: 1px solid var(--border-color);
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 12px;
        height: 12px;
      }

      ::-webkit-scrollbar-track {
        background: var(--bg-color);
      }

      ::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 6px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--line-number-color);
      }

      /* Add error message styling */
      .error-message {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #ff4444;
        color: white;
        padding: 10px 20px;
        border-radius: 4px;
        display: none;
        animation: fadeIn 0.3s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Add new style for word wrap */
      .editor.word-wrap {
        white-space: pre-wrap;
        overflow-wrap: break-word;
        overflow-x: hidden;
      }

      /* Add new styles for the selection popup */
      .selection-popup {
        position: absolute;
        background: var(--toolbar-bg);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        display: none;
        z-index: 1000;
      }

      .selection-popup button {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        background: none;
        border: none;
        color: var(--text-color);
        cursor: pointer;
        white-space: nowrap;
        width: 100%;
        border-radius: 4px;
      }

      .selection-popup button:hover {
        background-color: var(--highlight-color);
      }

      .selection-popup button svg {
        width: 16px;
        height: 16px;
        fill: currentColor;
      }

      .tab-name-input {
        background: var(--bg-color);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        padding: 2px 4px;
        font-family: inherit;
        font-size: inherit;
        outline: none;
        width: 100px;
      }

      * Table styles */ .table-container {
        overflow-x: auto;
        margin: 1em 0;
      }

      .preview-panel table {
        border-collapse: collapse;
        width: 100%;
        margin: 1.5em 0;
        font-size: 0.95em;
        min-width: 400px;
        border: 1px solid var(--border-color);
      }

      .preview-panel thead {
        background-color: var(--toolbar-bg);
      }

      .preview-panel th {
        background-color: var(--toolbar-bg);
        border: 1px solid var(--border-color);
        padding: 12px 15px;
        font-weight: bold;
        text-align: left;
      }

      .preview-panel td {
        border: 1px solid var(--border-color);
        padding: 12px 15px;
        vertical-align: top;
        line-height: 1.4;
      }

      .preview-panel tr:nth-child(even) {
        background-color: var(--tab-bg);
      }

      .preview-panel tr:hover {
        background-color: var(--highlight-color);
        transition: background-color 0.2s ease;
      }

      /* Handle long content in cells */
      .preview-panel td,
      .preview-panel th {
        max-width: 300px;
        overflow-wrap: break-word;
        word-wrap: break-word;
      }

      /* Emoji in tables */
      .preview-panel td:last-child {
        text-align: center;
        font-size: 1.1em;
      }
      .preview-mode .editor-container {
        display: none;
      }

      .preview-panel {
        display: none;
        flex: 1; /* Added */
        padding: 20px 40px;
        overflow-y: auto;
        min-height: 0; /* Added for Firefox */
      }

      .preview-mode .preview-panel {
        display: block;
      }

      /* Markdown preview styles */
      .preview-panel h1 {
        font-size: 2em;
        margin-bottom: 0.5em;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.3em;
      }

      .preview-panel h2 {
        font-size: 1.5em;
        margin-bottom: 0.5em;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.3em;
      }

      .preview-panel h3 {
        font-size: 1.25em;
        margin-bottom: 0.5em;
      }

      .preview-panel p {
        margin-bottom: 1em;
        line-height: 1.6;
      }

      .preview-panel ul,
      .preview-panel ol {
        margin-bottom: 1em;
        padding-left: 2em;
      }

      .preview-panel li {
        margin-bottom: 0.5em;
      }

      .preview-panel code {
        background-color: var(--toolbar-bg);
        padding: 0.2em 0.4em;
        border-radius: 3px;
        font-family: "JetBrains Mono", monospace;
      }

      .preview-panel pre {
        background-color: var(--toolbar-bg);
        padding: 1em;
        border-radius: 5px;
        overflow-x: auto;
        margin-bottom: 1em;
      }

      .preview-panel blockquote {
        border-left: 4px solid var(--border-color);
        padding-left: 1em;
        margin-bottom: 1em;
        color: var(--line-number-color);
      }

      .preview-panel img {
        max-width: 100%;
        height: auto;
      }

      .preview-panel table {
        border-collapse: collapse;
        width: 100%;
        margin-bottom: 1em;
      }

      .preview-panel th,
      .preview-panel td {
        border: 1px solid var(--border-color);
        padding: 0.5em;
      }

      .preview-panel th {
        background-color: var(--toolbar-bg);
      }
    </style>
  </head>

  <body>
    <div class="toolbar">
      <!-- <button onclick="newFile()" title="New File">
        <svg viewBox="0 0 24 24">
          <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
        </svg>
      </button> -->
      <!-- <button onclick="saveCurrentFile()" title="Save">
        <svg viewBox="0 0 24 24">
          <path
            d="M17 3H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V7l-4-4zm2 16H5V5h11.17L19 7.83V19zm-7-7c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"
          />
        </svg>
      </button> -->
      <button onclick="downloadCurrentFile()" title="Download">
        <svg viewBox="0 0 24 24">
          <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
        </svg>
      </button>
      <button
        onclick="document.getElementById('fileInput').click()"
        title="Open File"
      >
        <svg viewBox="0 0 24 24">
          <path
            d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"
          />
        </svg>
      </button>
      <button onclick="toggleTheme()" title="Toggle Theme">
        <svg viewBox="0 0 24 24">
          <path
            d="M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6zm0-10c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"
          />
        </svg>
      </button>
      <button onclick="formatJSON()" title="Format JSON">
        <svg viewBox="0 0 24 24">
          <path
            d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM9 18H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zM9 10H7V8h2v2zm4 0h-2V8h2v2zm4 0h-2V8h2v2z"
          />
        </svg>
      </button>
      <button onclick="setAPIKey()" id="apiKeyButton" title="Set API Key">
        <svg viewBox="0 0 24 24">
          <path
            d="M22 19h-6v-4h-2.68c-1.14 2.42-3.6 4-6.32 4-3.86 0-7-3.14-7-7s3.14-7 7-7c2.72 0 5.17 1.58 6.32 4H24v6h-2v4zm-4-2h2v-4h2v-2H11.94l-.23-.67C11.01 8.34 9.11 7 7 7c-2.76 0-5 2.24-5 5s2.24 5 5 5c2.11 0 4.01-1.34 4.71-3.33l.23-.67H18v4zM7 15c-1.65 0-3-1.35-3-3s1.35-3 3-3 3 1.35 3 3-1.35 3-3 3zm0-4c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"
          />
        </svg>
      </button>
      <!-- <button
        onclick="improveSelectedText()"
        title="Improve Text"
        class="improve-text"
      >
        <svg viewBox="0 0 24 24">
          <path
            d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"
          />
        </svg>
      </button> -->
      <button onclick="convertTimestamp()" title="Convert Time">
        <svg viewBox="0 0 24 24">
          <path
            d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"
          />
        </svg>
      </button>
      <button onclick="toggleWordWrap()" title="Toggle Word Wrap">
        <svg viewBox="0 0 24 24">
          <path
            d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3 3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"
          />
        </svg>
      </button>
      <button onclick="togglePreview()" title="Toggle Preview">
        <svg viewBox="0 0 24 24">
          <path
            d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"
          />
        </svg>
      </button>
    </div>
    <div class="main-container">
      <div class="content-container">
        <div class="editor-container" id="editorContainer"></div>
        <div class="preview-panel" id="previewPanel"></div>
        <div class="status-bar">
          <span id="statusFileName">Untitled</span>
          <span id="selectionInfo"></span>
          <span id="statusInfo">Ln 1, Col 1</span>
        </div>
      </div>
      <div class="tabs-container" id="tabsContainer"></div>
    </div>

    <div id="errorMessage" class="error-message"></div>

    <!-- Add new selection popup HTML -->
    <div id="selectionPopup" class="selection-popup">
      <button onclick="improveSelectedText()">
        <svg viewBox="0 0 24 24">
          <path
            d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"
          />
        </svg>
      </button>
    </div>

    <script>
      let tabs = [];
      let activeTabId = null;
      let currentTheme = "dark";

      // Add this at the start of your JavaScript code
      const dbName = "EditorDB";
      const dbVersion = 1;
      let db;

      // Initialize IndexedDB
      async function initDB() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(dbName, dbVersion);

          request.onerror = () => reject(request.error);
          request.onsuccess = () => {
            db = request.result;
            resolve(db);
          };

          request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains("tabs")) {
              db.createObjectStore("tabs", { keyPath: "id" });
            }
          };
        });
      }

      // Tab class to manage individual tabs
      class Tab {
        constructor(id, name = "Untitled", content = "") {
          this.id = id;
          this.name = name;
          this.content = content;
          this.wordWrap = localStorage.getItem("wordWrap") === "true";
          this.createElements();
          this.setupTabNameEditing(); // Add this line
          this.setupSelectionPopup();

          // Add keyboard shortcut handling to the editor
          this.editor.addEventListener("keydown", (e) => {
            if (e.key === "Tab") {
              this.handleTabKey(e);
            }
          });

          // Apply word wrap setting
          if (this.wordWrap) {
            this.editor.classList.add("word-wrap");
          }

          this.editor.addEventListener("keydown", (e) => {
            if (e.key === "Tab") {
              this.handleTabKey(e);
            }

            // Add horizontal line shortcut (Ctrl + -)
            if (e.ctrlKey && e.key === "l") {
              e.preventDefault();
              this.insertHorizontalLine();
            }
            if (e.ctrlKey && e.key === "Enter") {
              e.preventDefault();
              this.toggleDoneStatus();
            }
          });

          // Add preview update to input event
          this.editor.addEventListener("input", () => {
            this.updateLineNumbers();
            this.saveToLocalStorage();
            if (
              document
                .querySelector(".content-container")
                .classList.contains("preview-mode")
            ) {
              updatePreview();
            }
          });
        }

        insertHorizontalLine() {
          const pos = this.editor.selectionStart;
          const value = this.editor.value;
          const horizontalLine =
            "\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n";

          this.editor.value =
            value.slice(0, pos) + horizontalLine + value.slice(pos);
          this.editor.selectionStart = this.editor.selectionEnd =
            pos + horizontalLine.length;
          this.updateLineNumbers();
          this.saveToLocalStorage();
        }

        async saveToIndexedDB() {
          const transaction = db.transaction(["tabs"], "readwrite");
          const store = transaction.objectStore("tabs");
          await store.put({
            id: this.id,
            name: this.name,
            content: this.editor.value,
          });
        }

        setupTabNameEditing() {
          const nameSpan = document.querySelector(
            `.tab-name[data-tab-id="${this.id}"]`
          );
          nameSpan.addEventListener("dblclick", (e) => {
            e.stopPropagation();
            const input = document.createElement("input");
            input.value = this.name;
            input.className = "tab-name-input";
            nameSpan.replaceWith(input);
            input.focus();
            input.select();

            const handleRename = () => {
              const newName = input.value.trim() || "Untitled";
              this.name = newName;
              const newSpan = document.createElement("span");
              newSpan.className = "tab-name";
              newSpan.setAttribute("data-tab-id", this.id);
              newSpan.textContent = newName;
              input.replaceWith(newSpan);
              document.getElementById("statusFileName").textContent = newName;
              this.saveToLocalStorage();
              this.setupTabNameEditing();
            };

            input.addEventListener("blur", handleRename);
            input.addEventListener("keydown", (e) => {
              if (e.key === "Enter") {
                handleRename();
              }
            });
          });
        }

        toggleDoneStatus() {
          const start = this.editor.selectionStart;
          const text = this.editor.value;
          const lineStart = text.lastIndexOf("\n", start - 1) + 1;
          const lineEnd = text.indexOf("\n", start);
          const currentLine = text.slice(
            lineStart,
            lineEnd === -1 ? text.length : lineEnd
          );

          const doneEmoji = "✅";
          const notDoneEmoji = "⬜";

          let newLine;
          if (currentLine.startsWith(doneEmoji)) {
            newLine = currentLine.replace(doneEmoji, notDoneEmoji);
          } else if (currentLine.startsWith(notDoneEmoji)) {
            newLine = currentLine.replace(notDoneEmoji, doneEmoji);
          } else {
            newLine = notDoneEmoji + " " + currentLine;
          }

          this.editor.value =
            text.slice(0, lineStart) +
            newLine +
            text.slice(lineEnd === -1 ? text.length : lineEnd);
          this.editor.selectionStart = this.editor.selectionEnd = lineStart;
          this.updateLineNumbers();
          this.saveToLocalStorage();
        }

        setupSelectionPopup() {
          const popup = document.getElementById("selectionPopup");
          let selectionTimeout;

          const updatePopupPosition = () => {
            const selectedText = this.editor.value.substring(
              this.editor.selectionStart,
              this.editor.selectionEnd
            );

            if (selectedText) {
              // Get the coordinates of the cursor/selection
              const editorRect = this.editor.getBoundingClientRect();

              // Create a temporary div to measure text dimensions
              const div = document.createElement("div");
              div.style.font = window.getComputedStyle(this.editor).font;
              div.style.position = "absolute";
              div.style.whiteSpace = "pre";
              div.style.visibility = "hidden";
              div.textContent = this.editor.value.substring(
                0,
                this.editor.selectionStart
              );
              document.body.appendChild(div);

              // Calculate position based on text measurements
              const textWidth = div.offsetWidth;
              const lines = div.textContent.split("\\n").length;
              const lineHeight = parseInt(
                window.getComputedStyle(this.editor).lineHeight
              );

              document.body.removeChild(div);

              // Calculate coordinates
              const x = editorRect.left + (textWidth % this.editor.clientWidth);
              const y =
                editorRect.top + lines * lineHeight - this.editor.scrollTop;

              // Position the popup
              popup.style.display = "block";
              popup.style.left =
                Math.min(x, editorRect.right - popup.offsetWidth - 10) + "px";
              popup.style.top = y - popup.offsetHeight - 10 + "px";
            } else {
              popup.style.display = "none";
            }
          };

          this.editor.addEventListener("mouseup", () => {
            clearTimeout(selectionTimeout);
            selectionTimeout = setTimeout(updatePopupPosition, 100);
          });

          this.editor.addEventListener("keyup", (e) => {
            if (
              e.shiftKey &&
              (e.key === "ArrowLeft" || e.key === "ArrowRight")
            ) {
              clearTimeout(selectionTimeout);
              selectionTimeout = setTimeout(updatePopupPosition, 100);
            }
          });

          // Hide popup when clicking outside
          document.addEventListener("mousedown", (e) => {
            if (!popup.contains(e.target) && e.target !== this.editor) {
              popup.style.display = "none";
            }
          });

          // Update popup position on scroll
          this.editor.addEventListener("scroll", () => {
            if (popup.style.display === "block") {
              updatePopupPosition();
            }
          });

          // Handle window resize
          window.addEventListener("resize", () => {
            if (popup.style.display === "block") {
              updatePopupPosition();
            }
          });
        }

        createElements() {
          // Create editor wrapper
          this.editorWrapper = document.createElement("div");
          this.editorWrapper.className = "editor-wrapper";
          this.editorWrapper.id = `editor-wrapper-${this.id}`;

          // Create line numbers
          this.lineNumbers = document.createElement("div");
          this.lineNumbers.className = "line-numbers";

          // Create editor
          this.editor = document.createElement("textarea");
          this.editor.className = "editor";
          this.editor.value = this.content;
          this.editor.spellcheck = false;

          // Add event listeners
          this.editor.addEventListener("input", () => {
            this.updateLineNumbers();
            this.saveToLocalStorage();
          });
          this.editor.addEventListener("scroll", () => {
            this.lineNumbers.scrollTop = this.editor.scrollTop;
          });
          this.editor.addEventListener("keyup", () => this.updateStatusBar());
          this.editor.addEventListener("click", () => this.updateStatusBar());
          this.editor.addEventListener("scroll", () => this.updateStatusBar());
          this.editor.addEventListener("keydown", this.handleTabKey.bind(this));

          // Assemble elements
          this.editorWrapper.appendChild(this.lineNumbers);
          this.editorWrapper.appendChild(this.editor);
          document
            .getElementById("editorContainer")
            .appendChild(this.editorWrapper);

          this.updateLineNumbers();
        }

        updateLineNumbers() {
          const lines = this.editor.value.split("\n");
          const lineCount = lines.length;
          const lineNumbersContent = Array.from(
            { length: lineCount },
            (_, i) => {
              const div = document.createElement("div");
              div.textContent = i + 1;
              return div;
            }
          );
          this.lineNumbers.innerHTML = "";
          lineNumbersContent.forEach((div) =>
            this.lineNumbers.appendChild(div)
          );
        }

        updateStatusBar() {
          const text = this.editor.value;
          const position = this.editor.selectionStart;
          const lines = text.substr(0, position).split("\n");
          const currentLine = lines.length;
          const currentColumn = lines[lines.length - 1].length + 1;

          document.getElementById(
            "statusInfo"
          ).textContent = `Ln ${currentLine}, Col ${currentColumn}`;

          // Get selected text length
          const selectionStart = this.editor.selectionStart;
          const selectionEnd = this.editor.selectionEnd;
          const selectedText = this.editor.value.substring(
            selectionStart,
            selectionEnd
          );
          const selectedLength = selectedText.length;
          const selectedWords = selectedText
            ? selectedText
                .trim()
                .split(/\s+/)
                .filter((word) => word.length > 0).length
            : 0;

          // Update selection info
          const selectionInfo = document.getElementById("selectionInfo");
          if (selectedLength > 0) {
            selectionInfo.textContent = `Sel ${selectedLength} chr, ${selectedWords} words`;
          } else {
            selectionInfo.textContent = "";
          }
        }

        handleTabKey(e) {
          if (e.key !== "Tab") return;

          e.preventDefault();
          const start = this.editor.selectionStart;
          const end = this.editor.selectionEnd;
          const text = this.editor.value;

          // Simple tab insertion if no text is selected
          if (start === end) {
            this.editor.value = text.slice(0, start) + "  " + text.slice(end);
            this.editor.selectionStart = this.editor.selectionEnd = start + 2;
            this.updateLineNumbers();
            this.saveToLocalStorage();
            return;
          }

          // Handle selected text
          let startLine = text.lastIndexOf("\n", start - 1) + 1;
          let endLine = text.indexOf("\n", end);
          if (endLine === -1) endLine = text.length;

          const selectedLines = text.slice(startLine, endLine).split("\n");

          if (e.shiftKey) {
            const unindentedLines = selectedLines.map((line) => {
              return line.startsWith("  ") ? line.slice(2) : line;
            });

            this.editor.value =
              text.slice(0, startLine) +
              unindentedLines.join("\n") +
              text.slice(endLine);

            this.editor.selectionStart = startLine;
            this.editor.selectionEnd =
              startLine + unindentedLines.join("\n").length;
          } else {
            const indentedLines = selectedLines.map((line) => "  " + line);

            this.editor.value =
              text.slice(0, startLine) +
              indentedLines.join("\n") +
              text.slice(endLine);

            this.editor.selectionStart = startLine;
            this.editor.selectionEnd =
              startLine + indentedLines.join("\n").length;
          }

          this.updateLineNumbers();
          this.saveToLocalStorage();
        }

        activate() {
          this.editorWrapper.classList.add("active");
          document.getElementById("statusFileName").textContent = this.name;
          this.updateStatusBar();
        }

        deactivate() {
          this.editorWrapper.classList.remove("active");
        }

        saveToLocalStorage() {
          this.saveToIndexedDB().catch(console.error);
        }
      }

      async function initEditor() {
        try {
          await initDB();

          const transaction = db.transaction(["tabs"], "readonly");
          const store = transaction.objectStore("tabs");

          return new Promise((resolve, reject) => {
            const request = store.getAll();

            request.onsuccess = () => {
              const savedTabs = request.result;
              if (savedTabs && savedTabs.length > 0) {
                savedTabs.forEach((tabData) => {
                  createTab(tabData.name, tabData.content, tabData.id);
                });
                setActiveTab(savedTabs[0].id);
              } else {
                createTab();
              }

              const savedTheme = localStorage.getItem("theme") || "dark";
              setTheme(savedTheme);
              resolve();
            };

            request.onerror = () => {
              console.error("Error loading tabs:", request.error);
              createTab();
              reject(request.error);
            };
          });
        } catch (error) {
          console.error("Database initialization failed:", error);
          createTab();
        }
      }

      function createTab(
        name = "Untitled",
        content = "",
        id = Date.now().toString()
      ) {
        // Reset preview mode when creating a new tab
        const contentContainer = document.querySelector(".content-container");
        if (contentContainer.classList.contains("preview-mode")) {
          togglePreview(); // Switch back to edit mode
        }

        // Create tab button
        const tabButton = document.createElement("button");
        tabButton.className = "tab";
        tabButton.innerHTML = `<span class="tab-name" data-tab-id="${id}">${name}</span>
    <button class="tab-close" onclick="closeTab('${id}', event)">×</button>`;
        tabButton.onclick = () => setActiveTab(id);
        document.getElementById("tabsContainer").appendChild(tabButton);

        // Create new tab instance
        const tab = new Tab(id, name, content);
        tabs.push({ id, tab, button: tabButton });

        return id;
      }

      function setActiveTab(id) {
        // Reset preview mode when switching tabs
        const contentContainer = document.querySelector(".content-container");
        if (contentContainer.classList.contains("preview-mode")) {
          togglePreview(); // Switch back to edit mode
        }

        // Deactivate current tab
        if (activeTabId) {
          const currentTab = tabs.find((t) => t.id === activeTabId);
          if (currentTab) {
            currentTab.tab.deactivate();
            currentTab.button.classList.remove("active");
          }
        }

        // Activate new tab
        const newTab = tabs.find((t) => t.id === id);
        if (newTab) {
          newTab.tab.activate();
          newTab.button.classList.add("active");
          activeTabId = id;
        }
      }

      async function closeTab(id, event) {
        event.stopPropagation();
        if (tabs.length === 1) {
          alert("Cannot close the last tab");
          return;
        }

        const tabIndex = tabs.findIndex((t) => t.id === id);
        if (tabIndex === -1) return;

        // Remove tab from IndexedDB
        const transaction = db.transaction(["tabs"], "readwrite");
        const store = transaction.objectStore("tabs");
        await store.delete(id);

        // Rest of the closeTab function remains the same
        const tab = tabs[tabIndex];
        tab.button.remove();
        tab.tab.editorWrapper.remove();
        tabs.splice(tabIndex, 1);

        if (activeTabId === id) {
          const newTabId = tabs[Math.min(tabIndex, tabs.length - 1)].id;
          setActiveTab(newTabId);
        }
      }

      function getCurrentTab() {
        return tabs.find((t) => t.id === activeTabId)?.tab;
      }

      // File operations
      function newFile() {
        const id = createTab();
        setActiveTab(id);
      }

      function saveCurrentFile() {
        const tab = getCurrentTab();
        if (tab) {
          tab.saveToLocalStorage();
          alert("File saved to browser storage");
        }
      }

      function downloadCurrentFile() {
        const tab = getCurrentTab();
        if (tab) {
          const blob = new Blob([tab.editor.value], { type: "text/plain" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          // Add .md extension if not already present
          const fileName = tab.name.endsWith(".md")
            ? tab.name
            : `${tab.name}.md`;
          a.download = fileName;
          a.click();
          URL.revokeObjectURL(url);
        }
      }

      function openFile(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const id = createTab(file.name, e.target.result);
            setActiveTab(id);
          };
          reader.readAsText(file);
        }
        event.target.value = ""; // Reset file input
      }

      // Theme switching
      function toggleTheme() {
        const newTheme = currentTheme === "dark" ? "light" : "dark";
        setTheme(newTheme);
      }

      function setTheme(theme) {
        document.documentElement.setAttribute("data-theme", theme);
        currentTheme = theme;
        localStorage.setItem("theme", theme);
      }

      // Add new function for JSON formatting
      function formatJSON() {
        const tab = getCurrentTab();
        if (!tab) return;

        try {
          const content = tab.editor.value.trim();
          if (!content) {
            showError("Editor is empty");
            return;
          }

          // Parse and stringify with indentation
          const parsed = JSON.parse(content);
          const formatted = JSON.stringify(parsed, null, 4);

          // Update editor content
          tab.editor.value = formatted;
          tab.updateLineNumbers();
          tab.saveToLocalStorage();

          // Set cursor position to start
          tab.editor.scrollTop = 0;
          tab.editor.scrollLeft = 0;
        } catch (error) {
          showError("Invalid JSON: " + error.message);
        }
      }

      // Add error message handling
      function showError(message) {
        const errorElement = document.getElementById("errorMessage");
        errorElement.textContent = message;
        errorElement.style.display = "block";

        // Hide after 3 seconds
        setTimeout(() => {
          errorElement.style.display = "none";
        }, 3000);
      }

      // API Key management
      function setAPIKey() {
        const currentKey = localStorage.getItem("anthropic_api_key") || "";
        const apiKey = prompt("Enter your Anthropic API key:", currentKey);
        if (apiKey !== null) {
          localStorage.setItem("anthropic_api_key", apiKey);
          showError("API key saved");
          updateAPIKeyButtonVisibility();
        }
      }

      function updateAPIKeyButtonVisibility() {
        const apiKeyButton = document.getElementById("apiKeyButton");
        const hasApiKey = !!localStorage.getItem("anthropic_api_key");
        apiKeyButton.style.display = hasApiKey ? "none" : "inline-block";
      }

      // Add context menu for Improve Text button to change API key
      document.addEventListener("DOMContentLoaded", () => {
        const improveButton = document.querySelector(".improve-text");
        improveButton.addEventListener("contextmenu", (e) => {
          e.preventDefault();
          setAPIKey();
        });
        updateAPIKeyButtonVisibility();
      });

      async function improveSelectedText() {
        const tab = getCurrentTab();
        if (!tab) return;

        const apiKey = localStorage.getItem("anthropic_api_key");
        if (!apiKey) {
          showError("Please set your API key first");
          return;
        }

        // Get selected text
        const start = tab.editor.selectionStart;
        const end = tab.editor.selectionEnd;
        const selectedText = tab.editor.value.substring(start, end);

        if (!selectedText) {
          showError("Please select some text to improve");
          return;
        }

        try {
          const response = await fetch(
            "https://api.anthropic.com/v1/messages",
            {
              method: "POST",
              headers: {
                "x-api-key": apiKey,
                "anthropic-version": "2023-06-01",
                "content-type": "application/json",
                "anthropic-dangerous-direct-browser-access": "true",
              },
              body: JSON.stringify({
                model: "claude-3-5-sonnet-20241022",
                max_tokens: 1024,
                messages: [
                  {
                    role: "user",
                    content: [
                      {
                        type: "text",
                        text:
                          "You are an expert in writing and grammar, tasked with improving the clarity and correctness of a given text. Your goal is to rewrite the provided text, making it grammatically correct and well-formatted while preserving its original meaning.\n\nHere is the text to rewrite:\n\n<text_to_rewrite>\n" +
                          selectedText +
                          "\n</text_to_rewrite>\n\nPlease follow these steps to improve the text:\n\n1. Read and analyze the provided text carefully.\n\n2. In your internal analysis, consider the following aspects:\n   - Spelling mistakes\n   - Punctuation errors\n   - Verb tense issues\n   - Word choice problems\n   - Other grammatical mistakes\n   - Formatting needs (e.g., paragraphs, bullet points)\n   - Tone and style of the original text\n\n3. List out specific examples of errors found in the text.\n\n4. Plan your approach for rewriting the text, including any necessary reorganization.\n\n5. Create a brief outline of the rewritten text.\n\n6. Rewrite the text, making the necessary corrections and improvements. Ensure that you:\n   - Correct all spelling, punctuation, and grammatical errors\n   - Improve clarity and readability\n   - Use appropriate formatting, including paragraphs and bullet points where needed\n   - Preserve the original meaning of the text\n   - Maintain the original tone and style as much as possible\n\n7. Review your rewritten version to ensure it accurately reflects the content and intent of the original text.\n\n8. Present only the final, improved text in your response. Do not include any commentary, explanations, or notes about the changes made.",
                      },
                    ],
                  },
                ],
              }),
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || "API request failed");
          }

          const data = await response.json();
          const improvedText = data.content[0].text
            .replace(/^"/, "") // Remove leading quote if present
            .replace(/"$/, "") // Remove trailing quote if present
            .replace(/^Here'?s the improved text:?\s*/i, "") // Remove "Here's the improved text:" prefix
            .trim(); // Remove any extra whitespace

          try {
            await navigator.clipboard.writeText(improvedText);
            showError("Improved text copied to clipboard!");
          } catch (clipboardError) {
            showError("Failed to copy to clipboard: " + clipboardError.message);
          }

          // Insert improved text below the selection with a separator
          const before = tab.editor.value.substring(0, end);
          const after = tab.editor.value.substring(end);
          tab.editor.value =
            before + "\n\n---\n" + improvedText + "\n---\n\n" + after;

          // Update editor state
          tab.updateLineNumbers();
          tab.saveToLocalStorage();
          showError("Text improved successfully");
        } catch (error) {
          showError("API Error: " + error.message);
        }
      }

      function convertTimestamp() {
        const tab = getCurrentTab();
        if (!tab) return;

        // Get selected text
        const start = tab.editor.selectionStart;
        const end = tab.editor.selectionEnd;
        const selectedText = tab.editor.value.substring(start, end).trim();

        if (!selectedText) {
          showError("Please select a timestamp to convert");
          return;
        }

        try {
          const timestamp = parseInt(selectedText);
          if (isNaN(timestamp)) throw new Error("Invalid timestamp");

          // Detect format (milliseconds or seconds) based on length
          const format =
            timestamp.toString().length === 13 ? "milliseconds" : "seconds";
          const ms = format === "seconds" ? timestamp * 1000 : timestamp;
          const date = new Date(ms);

          if (date.toString() === "Invalid Date")
            throw new Error("Invalid timestamp");

          // Create formatted result
          const result = `\n\n---\nFormat: ${format}\nUTC: ${date.toUTCString()}\nLocal: ${date.toString()}\n---\n\n`;

          // Insert result after the selected timestamp
          const before = tab.editor.value.substring(0, end);
          const after = tab.editor.value.substring(end);
          tab.editor.value = before + result + after;

          // Update editor state
          tab.updateLineNumbers();
          tab.saveToLocalStorage();
        } catch (error) {
          showError("Invalid timestamp format");
          const convertButton = document.querySelector(".convert-timestamp");
          convertButton.classList.add("error");
          setTimeout(() => {
            convertButton.classList.remove("error");
          }, 2000);
        }
      }

      // Add keyboard shortcuts handler
      document.addEventListener("keydown", (e) => {
        // Ctrl+W to close current tab
        if (e.ctrlKey && e.key === "w") {
          e.preventDefault();
          if (activeTabId) {
            closeTab(activeTabId, new Event("dummy"));
          }
        }

        // Escape to clear editor content
        if (e.key === "Escape") {
          const tab = getCurrentTab();
          if (tab) {
            tab.editor.value = "";
            tab.updateLineNumbers();
            tab.saveToLocalStorage();
          }
        }
      });

      // Add double-click handler for new tab creation
      document
        .querySelector(".tabs-container")
        .addEventListener("dblclick", (e) => {
          // Only create new tab if clicking on the tabs container itself, not on existing tabs
          if (e.target === document.querySelector(".tabs-container")) {
            newFile();
          }
        });

      // Add word wrap toggle function
      function toggleWordWrap() {
        const wordWrap = localStorage.getItem("wordWrap") === "true";
        const newWordWrap = !wordWrap;
        localStorage.setItem("wordWrap", newWordWrap);

        // Apply to all tabs
        tabs.forEach((tab) => {
          if (newWordWrap) {
            tab.tab.editor.classList.add("word-wrap");
          } else {
            tab.tab.editor.classList.remove("word-wrap");
          }
        });

        // Show feedback
        showError(newWordWrap ? "Word wrap enabled" : "Word wrap disabled");
      }

      function togglePreview() {
        const contentContainer = document.querySelector(".content-container");
        const previewPanel = document.getElementById("previewPanel");
        const isPreviewMode = contentContainer.classList.toggle("preview-mode");
        const previewButton = document.querySelector(
          '[title="Toggle Preview"]'
        );

        if (isPreviewMode) {
          updatePreview();
          previewButton.innerHTML = `
                  <svg viewBox="0 0 24 24">
                      <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                  </svg>`;
          previewButton.title = "Edit Mode";
        } else {
          previewButton.innerHTML = `
                  <svg viewBox="0 0 24 24">
                      <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                  </svg>`;
          previewButton.title = "Toggle Preview";
        }
      }
      function updatePreview() {
        const tab = getCurrentTab();
        if (!tab) return;

        const markdown = tab.editor.value;
        const html = convertMarkdownToHtml(markdown);
        document.getElementById("previewPanel").innerHTML = html;
      }

      function convertMarkdownToHtml(markdown) {
        // Basic Markdown parsing
        let html = markdown
          // Headers
          .replace(/^# (.*$)/gm, "<h1>$1</h1>")
          .replace(/^## (.*$)/gm, "<h2>$1</h2>")
          .replace(/^### (.*$)/gm, "<h3>$1</h3>")
          .replace(/^### (.*$)/gm, "<h3>$1</h3>")
          .replace(/^#### (.*$)/gm, "<h3>$1</h4>")

          // Bold and Italic
          .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
          .replace(/\*(.*?)\*/g, "<em>$1</em>")
          .replace(/_(.*?)_/g, "<em>$1</em>")

          // Code blocks
          .replace(/```([^`]+)```/g, "<pre><code>$1</code></pre>")
          .replace(/`([^`]+)`/g, "<code>$1</code>")

          // Lists
          .replace(/^\s*\d+\.\s+(.*$)/gm, "<ol><li>$1</li></ol>")
          .replace(/^\s*[\-\*]\s+(.*$)/gm, "<ul><li>$1</li></ul>")

          // Links
          .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')

          // Images
          .replace(/!\[([^\]]+)\]\(([^)]+)\)/g, '<img src="$2" alt="$1">')

          // Blockquotes
          .replace(/^\> (.*$)/gm, "<blockquote>$1</blockquote>")

          // Paragraphs
          .replace(
            /^(?!<[^>]+>)((?:[^<]|<(?!\/?(h[1-6]|ul|ol|li|blockquote|pre|code)>))+)$/gm,
            "<p>$1</p>"
          );

        // Clean up list items
        html = html.replace(/<\/ul>\s*<ul>/g, "").replace(/<\/ol>\s*<ol>/g, "");

        return html;
      }

      // Update the script initialization
      document.addEventListener("DOMContentLoaded", () => {
        initEditor().catch(console.error);
      });
    </script>
  </body>
</html>
